<script setup>
import {shallowReactive, reactive, ref, computed, watch} from 'vue';
import {profiles} from '@/profiles';
import Welcome from "@/components/Welcome.vue";
import Help from "@/components/Help.vue";

import SpreadSheet from "@/components/SpreadSheet.vue";
import {Validator} from "@/utils/profileValidator.js";
import {isEmpty, isUndefined} from "lodash";
import {ROCrate} from "ro-crate";
import {useRouter} from 'vue-router';

const $router = useRouter();

const emit = defineEmits(['load:spreadsheet']);
const defaultProfile = 0;

const data = shallowReactive({
  /** @type {?FileSystemDirectoryHandle} */
  dirHandle: null,
  /** @type {?FileSystemFileHandle} */
  metadataHandle: null,
  crate: null,
  entityId: '',
  selectedProfile: defaultProfile,
  profiles: shallowReactive(profiles),
  spreadSheetBuffer: null,
  loading: false,
  profileError: [],
  profileErrorDialog: false,
  validationResult: {},
  showWelcome: false
});
//window.data = data;
const profile = computed(() => data.profiles[data.selectedProfile]);

const editor = ref();

const commands = {
  async loadProfile() {
    console.log('loading profile');
    try {
      const [profileHandle] = await window.showOpenFilePicker();
      let file = await profileHandle.getFile();
      const content = await file.text();
      const validator = new Validator();
      validator.errors = [];
      validator.loadAndCheck(content);
      data.profileError = null;
      data.profileErrorDialog = false;
      if (validator.errors.length > 0) {
        data.profileError = validator.errors;
        data.profileErrorDialog = true;
      } else {
        //const profile = validator.profile;
        //TODO: put it profiles removing it when fixing it
        const newProfile = validator.profile;
        data.profiles.unshift(newProfile);
        data.selectedProfile = 0;
        //profile = newProfile;
      }
    } catch (error) {
      console.error(error);
      window.alert(error);
    }
  },

  async open() {
    try {
      data.dirHandle = await window.showDirectoryPicker();
      // reset crate
      data.metadataHandle = null;
      try {
        data.metadataHandle = await data.dirHandle.getFileHandle('ro-crate-metadata.json');
      } catch (error) {
        try {
          data.metadataHandle = await data.dirHandle.getFileHandle('ro-crate-metadata.jsonld');
        } catch (error) {
          //No metadataHandle found start a new Crate
        }
      }
      if (data.metadataHandle) {
        data.loading = true;
        let file = await data.metadataHandle.getFile();
        const content = await file.text();
        data.crate = JSON.parse(content);
      } else {
        data.crate = {};
      }
      //data.loading = false;
    } catch (error) {
      console.error(error);
      window.alert(error);
    }
  },

  async addFiles() {
    const dirHandle = data.dirHandle;
    editor.value.rootDataset.hasPart = await collectFiles({dirHandle, root: ''});
  },

  async save() {
    if (data.dirHandle) {
      // create new crate metadata
      data.metadataHandle = await data.dirHandle.getFileHandle('ro-crate-metadata.json', {create: true});
    } else {
      try {
        data.metadataHandle = await window.showSaveFilePicker({
          suggestedName: 'ro-crate-metadata.json',
          types: [{
            description: 'RO-Crate Metadata File',
            accept: {'application/json': ['.json']}
          }]
        });
      } catch (error) {
      }
    }
    if (data.metadataHandle) {
      const writable = await data.metadataHandle.createWritable();
      const content = JSON.stringify(editor.value.crate, null, 2);
      await writable.write(content);
      await writable.close();
      data.crate = editor.value.crate;
      data.validationResult = validate(data.crate, profile.value);
      data.validationResultDialog = !isEmpty(data.validationResult);
    }
  },

  close() {
    data.dirHandle = null;
    data.metadataHandle = null;
    data.crate = null;
    data.entityId = '';
    data.selectedProfile = defaultProfile;
    data.profiles = shallowReactive(profiles);
    data.spreadSheetBuffer = null;
    data.loading = false;
  },

  async loadSpreadsheet() {

    const [excelHandle] = await window.showOpenFilePicker({
      types: [{
        description: 'Excel File with RO-Crate columns',
        accept: {'application/vnd.ms-excel': ['.xlsx']}
      }]
    });
    let file = await excelHandle.getFile();
    const buffer = await file.arrayBuffer();
    data.crate = editor.value.crate;
    data.spreadSheetBuffer = buffer;
  },

  help() {
    data.showWelcome = true;
  }
};

const excludedFiles = {
  'ro-crate-metadata.json': '',
  'node_modules': ''
};

/**
 *
 * @param {object} param0
 * @param {FileSystemDirectoryHandle} param0.dirHandle
 * @param {string} param0.root
 */
async function collectFiles({dirHandle, root}) {
  const files = [];
  /** @type {[string, FileSystemFileHandle|FileSystemDirectoryHandle][]} */
  const stack = [[root, dirHandle]];
  /** @type {[string, FileSystemFileHandle|FileSystemDirectoryHandle]} */
  var entry;
  while ((entry = stack.pop())) {
    let [name, handle] = entry;
    if (handle.kind === 'directory') {
      if (name) name += '/'
      const entries = [];
      for await (const entry of handle.entries()) {
        entries.push(entry);
      }
      for (var i = entries.length; i--;) {
        const e = entries[i];
        if (!e[0].startsWith('.') && !(e[0] in excludedFiles)) {
          e[0] = name + e[0];
          stack.push(e);
        }
      }
    } else {
      files.push({"@id": name, "@type": "File"});
    }
  }
  return files;
}

// this is a workaround for el-select to revert the modelValue change to the valid option
watch(() => data.selectedProfile, (v, pv) => {
  if (v < 0) {
    data.selectedProfile = pv;
    commands.loadProfile();
  }
});

const menuSelect = (key, keyPath) => {
  console.log(key, keyPath);
  commands[key]();
}

const validate = function (json, profile) {
  const crate = new ROCrate(json, {array: true, link: true});
  let validationResult = {};
  for (let entity of crate.entities()) {
    if (entity["@id"] !== 'ro-crate-metadata.json') {
      for (let entityType of entity['@type']) {
        const classDefinition = profile.classes[entityType];
        if (classDefinition) {
          for (let input of classDefinition.inputs) {
            if (input.required && (isUndefined(entity[input.name]) || entity[input.name] === '')) {
              //TODO: check that the input value is valid
              validationResult[entity['@id']] = validationResult[entity['@id']] || {};
              validationResult[entity['@id']] = {name: input.name, type: 'Required'};
            }
          }
        }
      }
    }
  }
  return validationResult;
}

const goTo = function (id) {
  data.validationResultDialog = false;
  $router.push({query: {id: encodeURIComponent(id)}});
}
</script>

<template>
  <div class="bg-slate-200">
    <el-menu
        default-active="-1"
        class=""
        background-color="#ecf5ff"
        text-color="#000"
        mode="horizontal"
        @select="menuSelect"
    >
      <el-menu-item index="open">
        üìÇ Open Directory
      </el-menu-item>
      <el-menu-item index="addFiles" :disabled="!data.dirHandle">
        üóÉÔ∏è Load Files
      </el-menu-item>
      <el-menu-item index="loadSpreadsheet" :disabled="!data.dirHandle">
        üóÑÔ∏è Bulk Add
      </el-menu-item>
      <el-menu-item index="save" :disabled="!data.dirHandle">
        üíæ Save
      </el-menu-item>
      <el-menu-item index="close" :disabled="!data.dirHandle">
        ‚ìß Close
      </el-menu-item>
      <el-menu-item title="Profile" class="">
        <template #title class="">
          Profile:&nbsp;
          <el-select v-model="data.selectedProfile" placeholder="Select a profile" class="w-96">
            <el-option :value="-1">
              <p class="font-bold italic">Load and add a new profile from your computer ...</p>
            </el-option>
            <el-option v-for="(profile, index) of data.profiles" :label="profile.metadata.name" :value="index">
              <div class="border-b-1 mb-2">
                <p>{{ profile.metadata.name }}</p>
                <p class="text-slate-500 text-xs">{{ profile.metadata.description }}</p>
              </div>
            </el-option>
          </el-select>
        </template>
      </el-menu-item>
      <el-menu-item index="help" title="Help">
        Ôπñ
      </el-menu-item>
    </el-menu>
    <el-row v-if="data.dirHandle" class="text-large p-3">
      Selected Directory:&nbsp;
      <span class="font-bold">{{ data.dirHandle.name }}</span>
    </el-row>
  </div>
  <template v-if="data.crate">
    <CrateEditor ref="editor" v-loading="data.loading" v-model:entityId="data.entityId"
                 :crate="data.crate" :profile="profile" @ready="data.loading = false">
    </CrateEditor>
    <SpreadSheet v-model:crate="data.crate" :buffer="data.spreadSheetBuffer"/>
  </template>
  <div v-else>
    <welcome/>
  </div>
  <el-dialog v-if="data.profileErrorDialog"
             v-model="data.profileError"
             :title="'Error when loading Profile'"
             width="50%"
  >
    <div class="overflow-x-scroll h-96">
      {{ data.selectedProfile?.metadata }}
      <el-divider/>
      <div class="p-2" v-for="error of data.profileError">
        <p>
          {{ error.instancePath }}
        </p>
        <p>
          {{ error.message }}
        </p>
        <el-divider/>
      </div>
    </div>
    <template #footer>
      <span class="dialog-footer">
        <el-button type="primary" @click="data.profileErrorDialog = false">Ok</el-button>
      </span>
    </template>
  </el-dialog>
  <el-dialog v-if="data.validationResultDialog"
             v-model="data.validationResult"
             :title="'Saved Crate with warnings'"
             width="50%"
  >
    <div class="overflow-x-scroll h-96">
      <div class="p-2" v-for="id of Object.keys(data.validationResult)">
        <p>
          Entity:
          <el-button @click=goTo(id)> {{ id }}</el-button>
          has the following warnings:
        </p>
        <div> Property : {{ data.validationResult[id]['name'] }} is {{ data.validationResult[id]['type'] }}</div>
        <el-divider/>
      </div>
    </div>
    <template #footer>
      <span class="dialog-footer">
        <el-button type="primary" @click="data.validationResultDialog = false">Ok</el-button>
      </span>
    </template>
  </el-dialog>
  <el-dialog v-if="data.showWelcome"
             v-model="data.showWelcome"
             title="Help"
             width="50%">
    <div class="overflow-x-scroll h-96">
      <help/>
    </div>
    <template #footer>
      <span class="dialog-footer">
        <el-button type="primary" @click="data.showWelcome = false">Close</el-button>
      </span>
    </template>
  </el-dialog>
</template>

<style>
.el-select-dropdown__item {
  height: auto;
}
</style>
